<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes y Pensiones - El Sabor de Marcona</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            background: #5a6268;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: #f8f9fa;
            color: #6c757d;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        /* Campos din√°micos */
        .dynamic-fields {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .dynamic-fields.show {
            display: block;
        }

        .dynamic-fields h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        /* Form containers */
        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Lista de clientes */
        .clientes-lista {
            margin-top: 30px;
        }

        .cliente-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cliente-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .cliente-info p {
            color: #666;
            margin: 2px 0;
        }

        .cliente-actions button {
            margin-left: 5px;
            padding: 6px 12px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .cliente-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cliente-actions {
                margin-top: 10px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="btn-back" onclick="window.location.href='main.html'">
            ‚Üê Regresar al Panel
        </button>
        
        <div class="header">
            <h1>üçΩÔ∏è Gesti√≥n de Clientes y Pensiones</h1>
            <p>Sistema de Administraci√≥n del Restaurante</p>
        </div>

        <!-- Pesta√±as -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('clientes')">
                üë• Gesti√≥n de Clientes
            </div>
            <div class="tab" onclick="switchTab('pensiones')">
                üèõÔ∏è Gesti√≥n de Pensiones
            </div>
        </div>

        <!-- PESTA√ëA 1: GESTI√ìN DE CLIENTES -->
        <div id="tab-clientes" class="tab-content active">
            <h2>Registro de Cliente</h2>
            <div id="alertContainer1"></div>
            
            <form id="clienteForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tipoCliente">Tipo de Cliente *</label>
                        <select id="tipoCliente" name="tipoCliente" required onchange="toggleClienteFields()">
                            <option value="">Seleccione el tipo...</option>
                            <option value="PARTICULAR">Particular</option>
                            <option value="PENSION">Pensionado</option>
                        </select>
                    </div>
                </div>

                <!-- Campos para PARTICULAR -->
                <div id="camposParticular" class="dynamic-fields">
                    <h4>üìù Datos de Cliente Particular</h4>
                    <div class="form-group">
                        <label for="nombreParticular">Nombre Completo *</label>
                        <input type="text" id="nombreParticular" placeholder="Ingrese el nombre completo">
                    </div>
                </div>

                <!-- Campos para PENSIONADO -->
                <div id="camposPensionado" class="dynamic-fields">
                    <h4>üë§ Datos de Pensionado</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="dniPensionado">DNI *</label>
                            <input type="text" id="dniPensionado" placeholder="12345678" maxlength="8" pattern="[0-9]{8}">
                        </div>
                        <div class="form-group">
                            <label for="nombresPensionado">Nombres *</label>
                            <input type="text" id="nombresPensionado" placeholder="Juan Carlos">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="apellidosPensionado">Apellidos *</label>
                        <input type="text" id="apellidosPensionado" placeholder="Garc√≠a L√≥pez">
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn" onclick="registrarCliente()">
                        Registrar Cliente
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormularioCliente()">
                        Limpiar
                    </button>
                </div>
            </form>

            <!-- Lista de Clientes -->
            <div class="clientes-lista">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Lista de Clientes</h2>
                    <button class="btn btn-secondary" onclick="cargarClientes()">
                        üîÑ Actualizar
                    </button>
                </div>
                
                <div class="form-group" style="max-width: 400px;">
                    <label for="buscarNombre">Buscar Cliente</label>
                    <input type="text" id="buscarNombre" placeholder="Ingrese nombre o DNI..."
                           oninput="buscarClientes()">
                </div>
                
                <div id="clientesLista">
                    <div class="loading">Cargando clientes...</div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA 2: GESTI√ìN DE PENSIONES -->
        <div id="tab-pensiones" class="tab-content">
            <h2>Gesti√≥n de Empresas y Pensiones</h2>
            <div id="alertContainer2"></div>
            
            <!-- SECCI√ìN 1: REGISTRO DE EMPRESAS -->
            <div class="form-container">
                <h3>üè¢ Registro de Empresa</h3>
                <form id="empresaForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rucEmpresa">RUC *</label>
                            <input type="text" id="rucEmpresa" placeholder="20123456789" maxlength="11" pattern="[0-9]{11}" required>
                        </div>
                        <div class="form-group">
                            <label for="razonSocial">Raz√≥n Social *</label>
                            <input type="text" id="razonSocial" placeholder="EMPRESA SAC" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" onclick="registrarEmpresa()">
                            Registrar Empresa
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormularioEmpresa()">
                            Limpiar
                        </button>
                    </div>
                </form>

                <!-- Lista de Empresas -->
                <div style="margin-top: 20px;">
                    <h4>Empresas Registradas</h4>
                    <div id="empresasLista">
                        <div class="loading">Cargando empresas...</div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 2: REGISTRO DE PENSIONES -->
            <div class="form-container" style="background: #e8f4fd;">
                <h3>üíº Registro de Pensi√≥n</h3>
                <form id="pensionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="empresaPension">Empresa *</label>
                            <select id="empresaPension" required>
                                <option value="">Seleccione una empresa...</option>
                                <!-- Se llenar√°n din√°micamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="clientePension">Cliente Pensionado *</label>
                            <select id="clientePension" required>
                                <option value="">Seleccione un cliente pensionado...</option>
                                <!-- Se llenar√°n din√°micamente -->
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="montoMensual">Monto Mensual (S/) *</label>
                            <input type="number" id="montoMensual" step="0.01" min="0" placeholder="150.00" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaInicio">Fecha de Inicio *</label>
                            <input type="date" id="fechaInicio" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fechaFin">Fecha de Fin *</label>
                        <input type="date" id="fechaFin" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" onclick="registrarPension()" id="btnRegistrarPension">
                            Registrar Pensi√≥n
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormularioPension()">
                            Limpiar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Pensiones -->
            <div class="clientes-lista">
                <h2>Pensiones Registradas</h2>
                <div id="pensionesList">
                    <div class="loading">Cargando pensiones...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
		// Variables globales
		let clientesData = [];
		let timeoutBusqueda = null;
		let registrandoPension = false; // Para evitar doble env√≠o

		// Inicializar p√°gina
		document.addEventListener('DOMContentLoaded', function() {
		    cargarClientes();
		    cargarClientesPensionados();
		    cargarEmpresas();
		    cargarPensiones(); // ‚úÖ AGREGADO: Cargar pensiones al inicio
		});

		// ‚úÖ CARGAR PENSIONES AL CAMBIAR A LA PESTA√ëA
		function switchTab(tabName) {
		    // C√≥digo existente...
		    document.querySelectorAll('.tab-content').forEach(tab => {
		        tab.classList.remove('active');
		    });
		    document.querySelectorAll('.tab').forEach(tab => {
		        tab.classList.remove('active');
		    });

		    document.getElementById(`tab-${tabName}`).classList.add('active');
		    event.target.classList.add('active');
		    
		    // ‚úÖ MEJORADO: Cargar datos espec√≠ficos con logs
		    if (tabName === 'pensiones') {
		        console.log('üîÑ Cambiando a pesta√±a de pensiones...');
		        cargarEmpresas();
		        cargarClientesPensionados();
		        cargarPensiones(); // ‚Üê Esta es la funci√≥n corregida
		    }
		}

		// Mostrar/ocultar campos seg√∫n tipo de cliente
		function toggleClienteFields() {
		    const tipo = document.getElementById('tipoCliente').value;
		    
		    // Ocultar todos los campos din√°micos
		    document.querySelectorAll('.dynamic-fields').forEach(field => {
		        field.classList.remove('show');
		    });

		    // Mostrar campos seg√∫n el tipo
		    if (tipo === 'PARTICULAR') {
		        document.getElementById('camposParticular').classList.add('show');
		    } else if (tipo === 'PENSION') {
		        document.getElementById('camposPensionado').classList.add('show');
		    }
		}

		// Registrar cliente
		async function registrarCliente() {
		    const tipo = document.getElementById('tipoCliente').value;
		    
		    if (!tipo) {
		        mostrarAlerta('Seleccione un tipo de cliente', 'error', 1);
		        return;
		    }

		    let clienteData = {
		        tipoCliente: tipo
		    };

		    // Validar y construir datos seg√∫n el tipo
		    if (tipo === 'PARTICULAR') {
		        const nombre = document.getElementById('nombreParticular').value.trim();
		        if (!nombre || nombre.length < 3) {
		            mostrarAlerta('El nombre debe tener al menos 3 caracteres', 'error', 1);
		            return;
		        }
		        clienteData.nombreCliente = nombre;
		        
		    } else if (tipo === 'PENSION') {
		        const dni = document.getElementById('dniPensionado').value.trim();
		        const nombres = document.getElementById('nombresPensionado').value.trim();
		        const apellidos = document.getElementById('apellidosPensionado').value.trim();
		        
		        if (!dni || dni.length !== 8 || !/^\d{8}$/.test(dni)) {
		            mostrarAlerta('DNI debe tener exactamente 8 d√≠gitos', 'error', 1);
		            return;
		        }
		        
		        if (!nombres || nombres.length < 2) {
		            mostrarAlerta('Los nombres son obligatorios', 'error', 1);
		            return;
		        }
		        
		        if (!apellidos || apellidos.length < 2) {
		            mostrarAlerta('Los apellidos son obligatorios', 'error', 1);
		            return;
		        }
		        
		        clienteData.dni = dni;
		        clienteData.nombres = nombres;
		        clienteData.apellidos = apellidos;
		    }

		    try {
		        const response = await fetch('/clientes/guardar', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                'Accept': 'application/json'
		            },
		            body: JSON.stringify(clienteData)
		        });

		        if (response.ok) {
		            mostrarAlerta('Cliente registrado exitosamente!', 'success', 1);
		            limpiarFormularioCliente();
		            cargarClientes();
		            cargarClientesPensionados(); // Actualizar lista de pensionados
		        } else {
		            const errorText = await response.text();
		            mostrarAlerta('Error al registrar: ' + errorText, 'error', 1);
		        }
		    } catch (error) {
		        console.error('Error:', error);
		        mostrarAlerta('Error de conexi√≥n al registrar cliente', 'error', 1);
		    }
		}

		// Cargar lista de clientes
		async function cargarClientes() {
		    try {
		        const response = await fetch('/clientes/api/buscar/todos');
		        if (!response.ok) throw new Error('Error al cargar clientes');
		        
		        clientesData = await response.json();
		        mostrarClientes(clientesData);
		        
		    } catch (error) {
		        console.error('Error:', error);
		        mostrarAlerta('Error al cargar clientes', 'error', 1);
		        document.getElementById('clientesLista').innerHTML = 
		            '<p style="text-align: center; color: #666; padding: 20px;">Error al cargar los clientes</p>';
		    }
		}

		// Mostrar clientes en la lista
		function mostrarClientes(clientes) {
		    const container = document.getElementById('clientesLista');
		    
		    if (!clientes || clientes.length === 0) {
		        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay clientes registrados</p>';
		        return;
		    }
		    
		    container.innerHTML = clientes.map(cliente => {
		        let nombreMostrar = '';
		        let infoExtra = '';
		        
		        if (cliente.tipoCliente === 'PENSION') {
		            nombreMostrar = `${cliente.nombres || ''} ${cliente.apellidos || ''}`.trim();
		            infoExtra = `<p><strong>DNI:</strong> ${cliente.dni || 'N/A'}</p>`;
		        } else {
		            nombreMostrar = cliente.nombreCliente || 'Sin nombre';
		        }
		        
		        return `
		            <div class="cliente-item">
		                <div class="cliente-info">
		                    <h4>${nombreMostrar}</h4>
		                    <p><strong>ID:</strong> ${cliente.idCliente}</p>
		                    <p><strong>Tipo:</strong> ${formatearTipoCliente(cliente.tipoCliente)}</p>
		                    ${infoExtra}
		                </div>
		                <div class="cliente-actions">
		                    <button class="btn btn-secondary" onclick="editarCliente(${cliente.idCliente})">
		                        ‚úèÔ∏è Editar
		                    </button>
		                    <button class="btn btn-danger" onclick="eliminarCliente(${cliente.idCliente}, '${nombreMostrar.replace(/'/g, "\\'")}')">
		                        üóëÔ∏è Eliminar
		                    </button>
		                </div>
		            </div>
		        `;
		    }).join('');
		}

		// Cargar clientes pensionados para el select
		async function cargarClientesPensionados() {
		    try {
		        const response = await fetch('/clientes/api/tipo/PENSION');
		        if (!response.ok) return;
		        
		        const clientes = await response.json();
		        const select = document.getElementById('clientePension');
		        
		        select.innerHTML = '<option value="">Seleccione un cliente pensionado...</option>';
		        
		        clientes.forEach(cliente => {
		            const nombre = cliente.nombres && cliente.apellidos 
		                ? `${cliente.nombres} ${cliente.apellidos}` 
		                : cliente.nombreCliente;
		            select.innerHTML += `<option value="${cliente.idCliente}">${nombre} (DNI: ${cliente.dni})</option>`;
		        });
		        
		    } catch (error) {
		        console.error('Error al cargar pensionados:', error);
		    }
		}

		// Registrar empresa
		async function registrarEmpresa() {
		    const ruc = document.getElementById('rucEmpresa').value.trim();
		    const razonSocial = document.getElementById('razonSocial').value.trim();

		    if (!ruc || ruc.length !== 11 || !/^\d{11}$/.test(ruc)) {
		        mostrarAlerta('RUC debe tener exactamente 11 d√≠gitos', 'error', 2);
		        return;
		    }

		    if (!razonSocial || razonSocial.length < 3) {
		        mostrarAlerta('La raz√≥n social debe tener al menos 3 caracteres', 'error', 2);
		        return;
		    }

		    const empresaData = {
		        ruc: ruc,
		        razonSocial: razonSocial
		    };

		    try {
		        const response = await fetch('/empresas/guardar', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                'Accept': 'application/json'
		            },
		            body: JSON.stringify(empresaData)
		        });

		        if (response.ok) {
		            mostrarAlerta('Empresa registrada exitosamente!', 'success', 2);
		            limpiarFormularioEmpresa();
		            cargarEmpresas();
		        } else {
		            const errorText = await response.text();
		            mostrarAlerta('Error al registrar empresa: ' + errorText, 'error', 2);
		        }
		    } catch (error) {
		        console.error('Error:', error);
		        mostrarAlerta('Error de conexi√≥n al registrar empresa', 'error', 2);
		    }
		}

		// Cargar empresas para los selects y lista
		async function cargarEmpresas() {
		    try {
		        const response = await fetch('/empresas/api/listar');
		        if (!response.ok) return;
		        
		        const empresas = await response.json();
		        
		        // Llenar select de empresas
		        const selectEmpresa = document.getElementById('empresaPension');
		        selectEmpresa.innerHTML = '<option value="">Seleccione una empresa...</option>';
		        
		        empresas.forEach(empresa => {
		            selectEmpresa.innerHTML += `<option value="${empresa.idEmpresa}">${empresa.razonSocial} (RUC: ${empresa.ruc})</option>`;
		        });

		        // Mostrar lista de empresas
		        mostrarEmpresas(empresas);
		        
		    } catch (error) {
		        console.error('Error al cargar empresas:', error);
		    }
		}

		// Mostrar empresas en la lista
		function mostrarEmpresas(empresas) {
		    const container = document.getElementById('empresasLista');
		    
		    if (!empresas || empresas.length === 0) {
		        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay empresas registradas</p>';
		        return;
		    }
		    
		    container.innerHTML = empresas.map(empresa => `
		        <div class="cliente-item">
		            <div class="cliente-info">
		                <h4>${empresa.razonSocial}</h4>
		                <p><strong>RUC:</strong> ${empresa.ruc}</p>
		                <p><strong>Estado:</strong> ${empresa.activo ? 'Activa' : 'Inactiva'}</p>
		            </div>
		            <div class="cliente-actions">
		                <button class="btn btn-secondary" onclick="editarEmpresa(${empresa.idEmpresa})">
		                    ‚úèÔ∏è Editar
		                </button>
		                <button class="btn btn-danger" onclick="eliminarEmpresa(${empresa.idEmpresa}, '${empresa.razonSocial}')">
		                    üóëÔ∏è Eliminar
		                </button>
		            </div>
		        </div>
		    `).join('');
		}

		// Buscar clientes
		function buscarClientes() {
		    clearTimeout(timeoutBusqueda);
		    const termino = document.getElementById('buscarNombre').value.trim();
		    
		    if (termino === '') {
		        mostrarClientes(clientesData);
		        return;
		    }
		    
		    timeoutBusqueda = setTimeout(() => {
		        const clientesFiltrados = clientesData.filter(cliente => {
		            const nombre = (cliente.nombreCompleto || cliente.nombreCliente || '').toLowerCase();
		            const dni = (cliente.dni || '').toLowerCase();
		            const terminoLower = termino.toLowerCase();
		            
		            return nombre.includes(terminoLower) || dni.includes(terminoLower);
		        });
		        
		        mostrarClientes(clientesFiltrados);
		    }, 300);
		}

		// ‚úÖ REEMPLAZA LA FUNCI√ìN registrarPension() en gestion-clientes.html

		async function registrarPension() {
		    console.log('üîÑ Iniciando registro de pensi√≥n...');
		    
		    // Evitar doble click
		    if (registrandoPension) {
		        console.log('‚ö†Ô∏è Ya se est√° registrando una pensi√≥n, evitando doble env√≠o');
		        return;
		    }
		    
		    registrandoPension = true;
		    const btnRegistrar = document.getElementById('btnRegistrarPension');
		    
		    try {
		        // Deshabilitar bot√≥n mientras registra
		        if (btnRegistrar) {
		            btnRegistrar.disabled = true;
		            btnRegistrar.textContent = 'Registrando...';
		        }
		        
		        const empresaId = document.getElementById('empresaPension').value;
		        const clienteId = document.getElementById('clientePension').value;
		        const monto = document.getElementById('montoMensual').value;
		        const fechaInicio = document.getElementById('fechaInicio').value;
		        const fechaFin = document.getElementById('fechaFin').value;

		        console.log('üìä Datos del formulario:', {
		            empresaId, clienteId, monto, fechaInicio, fechaFin
		        });

		        // Validaciones b√°sicas
		        if (!empresaId || !clienteId || !monto || !fechaInicio || !fechaFin) {
		            mostrarAlerta('Todos los campos son obligatorios', 'error', 2);
		            return;
		        }

		        if (new Date(fechaFin) <= new Date(fechaInicio)) {
		            mostrarAlerta('La fecha de fin debe ser posterior a la fecha de inicio', 'error', 2);
		            return;
		        }

		        if (parseFloat(monto) <= 0) {
		            mostrarAlerta('El monto mensual debe ser mayor a 0', 'error', 2);
		            return;
		        }

		        const pensionData = {
		            empresaId: parseInt(empresaId),
		            clienteId: parseInt(clienteId),
		            montoMensual: parseFloat(monto),
		            fechaInicio: fechaInicio,
		            fechaFin: fechaFin
		        };

		        console.log('üì§ Enviando datos al servidor:', pensionData);

		        const response = await fetch('/pensiones/guardar', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                'Accept': 'application/json'
		            },
		            body: JSON.stringify(pensionData)
		        });

		        console.log('üì° Response status:', response.status);

		        if (response.ok) {
		            const responseText = await response.text();
		            console.log('‚úÖ Respuesta del servidor:', responseText);
		            
		            mostrarAlerta('‚úÖ Pensi√≥n registrada exitosamente!', 'success', 2);
		            limpiarFormularioPension();
		            
		            // ‚úÖ IMPORTANTE: Recargar pensiones despu√©s de registrar
		            console.log('üîÑ Recargando lista de pensiones...');
		            setTimeout(() => {
		                cargarPensiones();
		            }, 500); // Peque√±o delay para asegurar que se guard√≥ en BD
		            
		        } else {
		            const errorText = await response.text();
		            console.error('‚ùå Error del servidor:', errorText);
		            mostrarAlerta('Error al registrar pensi√≥n: ' + errorText, 'error', 2);
		        }
		        
		    } catch (error) {
		        console.error('‚ùå Error de conexi√≥n:', error);
		        mostrarAlerta('Error de conexi√≥n al registrar pensi√≥n: ' + error.message, 'error', 2);
		        
		    } finally {
		        registrandoPension = false;
		        
		        // Rehabilitar bot√≥n
		        if (btnRegistrar) {
		            btnRegistrar.disabled = false;
		            btnRegistrar.textContent = 'Registrar Pensi√≥n';
		        }
		    }
		}

		// ‚úÖ FUNCI√ìN CARGAR PENSIONES - CORREGIDA
		async function cargarPensiones() {
		    console.log('üîÑ Iniciando carga de pensiones...');
		    
		    try {
		        const response = await fetch('/pensiones/api/listar', {
		            method: 'GET',
		            headers: {
		                'Accept': 'application/json',
		                'Content-Type': 'application/json'
		            }
		        });
		        
		        console.log('üì° Response status:', response.status);
		        console.log('üì° Response ok:', response.ok);
		        
		        if (!response.ok) {
		            const errorText = await response.text();
		            console.error('‚ùå Error response:', errorText);
		            throw new Error(`HTTP ${response.status}: ${errorText}`);
		        }
		        
		        const pensiones = await response.json();
		        console.log('‚úÖ Pensiones recibidas:', pensiones);
		        console.log('üìä Cantidad de pensiones:', pensiones.length);
		        
		        mostrarPensiones(pensiones);
		        
		    } catch (error) {
		        console.error('‚ùå Error completo al cargar pensiones:', error);
		        
		        const container = document.getElementById('pensionesList');
		        if (container) {
		            container.innerHTML = `
		                <div style="text-align: center; color: #dc3545; padding: 40px; background: #f8d7da; border-radius: 8px;">
		                    <h4>‚ùå Error al cargar pensiones</h4>
		                    <p><strong>Detalle:</strong> ${error.message}</p>
		                    <button class="btn" onclick="cargarPensiones()" style="margin-top: 15px;">
		                        üîÑ Reintentar
		                    </button>
		                </div>
		            `;
		        }
		        
		        mostrarAlerta('Error al cargar pensiones: ' + error.message, 'error', 2);
		    }
		}


		// ‚úÖ FUNCI√ìN MOSTRAR PENSIONES - CORREGIDA
		function mostrarPensiones(pensiones) {
		    console.log('üîÑ Mostrando pensiones en UI...');
		    console.log('üìä Datos recibidos:', pensiones);
		    
		    const container = document.getElementById('pensionesList');
		    
		    if (!container) {
		        console.error('‚ùå Container pensionesList no encontrado');
		        return;
		    }
		    
		    if (!pensiones || pensiones.length === 0) {
		        console.log('‚ÑπÔ∏è No hay pensiones para mostrar');
		        container.innerHTML = `
		            <div style="text-align: center; color: #666; padding: 40px;">
		                <h4>üìã No hay pensiones registradas</h4>
		                <p>Las pensiones que registres aparecer√°n aqu√≠.</p>
		            </div>
		        `;
		        return;
		    }
		    
		    console.log('‚úÖ Generando HTML para', pensiones.length, 'pensiones');
		    
		    try {
		        container.innerHTML = pensiones.map((pension, index) => {
		            console.log(`üìù Procesando pensi√≥n ${index + 1}:`, pension);
		            
		            // Obtener datos del cliente de forma segura
		            let nombreCliente = 'Cliente no encontrado';
		            let dniCliente = '';
		            
		            if (pension.cliente) {
		                if (pension.cliente.nombres && pension.cliente.apellidos) {
		                    nombreCliente = `${pension.cliente.nombres} ${pension.cliente.apellidos}`;
		                    dniCliente = pension.cliente.dni || '';
		                } else if (pension.cliente.nombreCliente) {
		                    nombreCliente = pension.cliente.nombreCliente;
		                }
		            }
		            
		            // Obtener datos de la empresa de forma segura
		            let nombreEmpresa = 'Sin empresa asignada';
		            if (pension.empresa && pension.empresa.razonSocial) {
		                nombreEmpresa = pension.empresa.razonSocial;
		            }
		            
		            // Datos b√°sicos de la pensi√≥n
		            const montoMensual = pension.montoMensual || 0;
		            const fechaInicio = formatearFecha(pension.fechaInicio);
		            const fechaFin = formatearFecha(pension.fechaFin);
		            const estado = obtenerEstadoPension(pension.fechaInicio, pension.fechaFin);
		            const idPension = pension.idPension || 'N/A';
		            
		            return `
		                <div class="cliente-item" style="background: #ffffff; border: 1px solid #dee2e6; margin-bottom: 15px;">
		                    <div class="cliente-info" style="flex: 1;">
		                        <h4 style="color: #2c3e50; margin-bottom: 10px;">üíº Pensi√≥n #${idPension}</h4>
		                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
		                            <div>
		                                <p><strong>üë§ Cliente:</strong> ${nombreCliente}</p>
		                                ${dniCliente ? `<p><strong>üìÑ DNI:</strong> ${dniCliente}</p>` : ''}
		                                <p><strong>üè¢ Empresa:</strong> ${nombreEmpresa}</p>
		                            </div>
		                            <div>
		                                <p><strong>üí∞ Monto Mensual:</strong> S/ ${Number(montoMensual).toFixed(2)}</p>
		                                <p><strong>üìÖ Inicio:</strong> ${fechaInicio}</p>
		                                <p><strong>üìÖ Fin:</strong> ${fechaFin}</p>
		                                <p><strong>üîÑ Estado:</strong> <span style="color: ${getColorEstado(estado)}; font-weight: bold;">${estado}</span></p>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="cliente-actions">
		                        <button class="btn btn-secondary" onclick="editarPension(${idPension})">
		                            ‚úèÔ∏è Editar
		                        </button>
		                        <button class="btn btn-danger" onclick="eliminarPension(${idPension}, '${nombreCliente.replace(/'/g, "\\'")}')">
		                            üóëÔ∏è Eliminar
		                        </button>
		                    </div>
		                </div>
		            `;
		        }).join('');
		        
		        console.log('‚úÖ HTML generado exitosamente');
		        
		    } catch (error) {
		        console.error('‚ùå Error generando HTML:', error);
		        container.innerHTML = `
		            <div style="text-align: center; color: #dc3545; padding: 20px;">
		                <h4>‚ùå Error mostrando pensiones</h4>
		                <p>${error.message}</p>
		            </div>
		        `;
		    }
		}

		// Funciones de limpieza
		function limpiarFormularioCliente() {
		    document.getElementById('clienteForm').reset();
		    document.querySelectorAll('.dynamic-fields').forEach(field => {
		        field.classList.remove('show');
		    });
		}

		function limpiarFormularioEmpresa() {
		    document.getElementById('empresaForm').reset();
		}

		function limpiarFormularioPension() {
		    document.getElementById('pensionForm').reset();
		}

		// Funci√≥n para eliminar cliente
		async function eliminarCliente(id, nombre) {
		    if (!confirm(`¬øEst√° seguro de eliminar al cliente "${nombre}"?`)) return;
		    
		    try {
		        const response = await fetch(`/clientes/eliminar/${id}`, { method: 'POST' });
		        
		        if (response.ok) {
		            mostrarAlerta('Cliente eliminado exitosamente', 'success', 1);
		            cargarClientes();
		        } else {
		            mostrarAlerta('Error al eliminar el cliente', 'error', 1);
		        }
		    } catch (error) {
		        mostrarAlerta('Error de conexi√≥n', 'error', 1);
		    }
		}

		// Funci√≥n para eliminar empresa
		async function eliminarEmpresa(id, nombre) {
		    if (!confirm(`¬øEst√° seguro de eliminar la empresa "${nombre}"?`)) return;
		    
		    try {
		        const response = await fetch(`/empresas/eliminar/${id}`, { method: 'POST' });
		        
		        if (response.ok) {
		            mostrarAlerta('Empresa eliminada exitosamente', 'success', 2);
		            cargarEmpresas();
		        } else {
		            mostrarAlerta('Error al eliminar la empresa', 'error', 2);
		        }
		    } catch (error) {
		        mostrarAlerta('Error de conexi√≥n', 'error', 2);
		    }
		}

		// ‚úÖ NUEVA FUNCI√ìN: ELIMINAR PENSI√ìN
		async function eliminarPension(id, nombreCliente) {
		    if (!confirm(`¬øEst√° seguro de eliminar la pensi√≥n del cliente "${nombreCliente}"?`)) {
		        return;
		    }
		    
		    try {
		        const response = await fetch(`/pensiones/eliminar/${id}`, { 
		            method: 'POST',
		            headers: {
		                'Accept': 'application/json'
		            }
		        });
		        
		        if (response.ok) {
		            mostrarAlerta('Pensi√≥n eliminada exitosamente', 'success', 2);
		            cargarPensiones(); // Recargar lista
		        } else {
		            const errorText = await response.text();
		            mostrarAlerta('Error: ' + errorText, 'error', 2);
		        }
		    } catch (error) {
		        console.error('Error:', error);
		        mostrarAlerta('Error de conexi√≥n al eliminar', 'error', 2);
		    }
		}

		// Funciones placeholder
		function editarCliente(id) {
		    mostrarAlerta('Funci√≥n de edici√≥n en desarrollo', 'error', 1);
		}

		function editarEmpresa(id) {
		    mostrarAlerta('Funci√≥n de edici√≥n en desarrollo', 'error', 2);
		}

		function editarPension(id) {
		    mostrarAlerta('Funci√≥n de edici√≥n en desarrollo', 'error', 2);
		}

		// Mostrar alertas
		function mostrarAlerta(mensaje, tipo, containerId) {
		    const container = document.getElementById(`alertContainer${containerId}`);
		    const alertClass = tipo === 'success' ? 'alert-success' : 'alert-error';
		    
		    container.innerHTML = `<div class="alert ${alertClass}">${mensaje}</div>`;
		    
		    setTimeout(() => {
		        container.innerHTML = '';
		    }, 5000);
		}

		// Formatear tipo de cliente
		function formatearTipoCliente(tipo) {
		    const tipos = {
		        'PARTICULAR': 'Particular',
		        'PENSION': 'Pensionado'
		    };
		    return tipos[tipo] || tipo;
		}

		// ‚úÖ FUNCIONES AUXILIARES NUEVAS
		function obtenerEstadoPension(fechaInicio, fechaFin) {
		    const hoy = new Date();
		    const inicio = new Date(fechaInicio);
		    const fin = new Date(fechaFin);
		    
		    if (hoy < inicio) {
		        return 'Pendiente';
		    } else if (hoy >= inicio && hoy <= fin) {
		        return 'Activa';
		    } else {
		        return 'Vencida';
		    }
		}

		function formatearFecha(fechaStr) {
		    if (!fechaStr) return 'N/A';
		    
		    try {
		        const fecha = new Date(fechaStr);
		        return fecha.toLocaleDateString('es-PE', {
		            day: '2-digit',
		            month: '2-digit',
		            year: 'numeric'
		        });
		    } catch (e) {
		        return fechaStr;
		    }
		}
		// ‚úÖ FUNCI√ìN AUXILIAR PARA COLOR DE ESTADO
		function getColorEstado(estado) {
		    switch (estado) {
		        case 'Activa': return '#28a745';
		        case 'Pendiente': return '#ffc107';
		        case 'Vencida': return '#dc3545';
		        default: return '#6c757d';
		    }
		}
    </script>
</body>
</html>